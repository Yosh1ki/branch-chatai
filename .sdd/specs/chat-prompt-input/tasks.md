# 実装タスクリスト

## セクション1：データモデル実装
- [x] 1.1 必要な型定義・データ構造を作成する
  - `Message.requestId`の型追加とユニーク制約の方針整理
  - LangGraphのグラフ状態型（履歴/要約/入力/メタ情報）を定義
- [x] 1.2 データ永続化層を実装する
  - Prismaスキーマ更新とマイグレーション作成
  - requestIdを使った冪等保存ヘルパーの実装

## セクション2：ビジネスロジック実装
- [x] 2.1 ChatRequestGraph（LangGraph）のコア処理を実装する
  - グラフ定義とノード遷移の構成
  - 入口で認証/入力検証/ブランチ整合性チェックを実装
- [x] 2.2 GraphNode群の処理を実装する
  - ConversationHistoryBuilderで履歴取得と時系列結合
  - HistorySummarizerで40件超過分の要約置換
  - SafetyFilterでFast Gateと外部モデレーションによる危険入力の拒否
  - 出力モデレーションの実装
  - ModelInvokerでストリーミング/フォールバック/再試行
  - UsageLimiterでFreeプラン上限判定
- [x] 2.3 エラーハンドリングを実装する
  - ブランチ整合性欠損/上限超過/危険入力のエラー応答
  - フォールバック/再試行の失敗時の最終エラー処理

## セクション3：インターフェース実装
- [x] 3.1 APIエンドポイントを作成する
  - `/api/chat`にLangGraph実行を組み込み
  - タイトル生成を初回応答後1回だけ起動する
- [x] 3.2 入力バリデーションを実装する
  - requestId/branchId/chatId/入力本文の検証
  - requestId未指定時の生成
  - モデル固定ルールの検証
- [x] 3.3 出力フォーマットを実装する
  - ストリーミングレスポンスの整形
  - 429/400/409などのエラー応答形式を統一

## セクション4：統合とテスト
- [x] 4.1 コンポーネントを統合する
  - GraphNodeと既存の`chat-service`/`chat-messages`を接続
  - メッセージ保存と使用量更新の統合
- [x] 4.2 基本的な動作テストを実装する
  - 履歴結合/要約/上限判定/安全判定のユニットテスト
  - `/api/chat`の統合テスト
- [ ] 4.3 要件の受入基準を満たすことを確認する
  - 分岐履歴の取得範囲/要約/フォールバック/再試行/429
  - PII非保存の確認
  - 未完了：ローカルでの受入確認が必要（APIキー/DB環境が必要）
