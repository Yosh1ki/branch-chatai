# 実装したい機能

## 概要
チャットAIの会話記憶と応答生成ルールの整理

## 詳細
### 会話記憶の範囲
- 現在のブランチから親チェーンをルートまで遡る
- 共通履歴（分岐点より前）は必ず含める
- 兄弟ブランチの履歴は含めない

### 履歴の結合順序
- 時系列で結合する

### 履歴の上限と要約
- 取得上限は直近40件までを基本とする
- 40件を超える分は短い要約に置き換える

### 生成フロー
- 履歴取得 → 要約（必要時） → モデル呼び出し → メッセージ保存

### モデル選択と失敗時の挙動
- チャット単位でモデルを固定し、失敗時は1段のみフォールバックする
- タイムアウト/レート制限時は1回だけ再試行する

### コスト/安全/ログ/品質
- トークン上限とレスポンス長上限は中程度の固定値を採用する
- ストリーミング表示を有効にする
- システムプロンプトは固定し、危険入力は拒否する
- ログはモデル名/トークン量/エラーのみを記録し、PIIは保存しない
- 優先順位は履歴 → 要約 → ツール結果の順とする

### データ整合性/使用量/タイトル
- requestIdによる冪等性を担保する
- ブランチ整合性の欠損時はエラーで応答する
- Freeプランの上限チェックと429応答は必須
- タイトル生成は初回応答後に1回だけ行う
